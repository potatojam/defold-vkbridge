<html>

<head>
    <script type="text/javascript">
        (function (d) {
            var VKBRIDGE_INIT_ID = 0
            var VKBRIDGE_SUBSCRIBE_ID = 1

            window.VkBridgeHelper = {};
            var VkBridgeHelper = window.VkBridgeHelper

            VkBridgeHelper.msgQueue = [];
            var send = function (cb_id, message_id, message) {
                if (typeof VkBridgeLibrary !== "undefined") {
                    VkBridgeLibrary.send(cb_id, message_id, message);
                } else {
                    VkBridgeHelper.msgQueue.push([cb_id, message_id, message]);
                }
            };

            VkBridgeHelper.conver_error = function (err) {
                var new_err;
                if (typeof err !== "object") {
                    new_err = {
                        error_type: "Unknown error",
                        error_data: {
                            error_code: -1,
                            error_reason: err + ""
                        }
                    };
                } else {
                    new_err = err;
                }
                return JSON.stringify(new_err);
            }

            VkBridgeHelper.init = function () {
                var t = d.getElementsByTagName("script")[0];
                var s = d.createElement("script");
                s.src = "https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js";
                s.async = true;
                t.parentNode.insertBefore(s, t);
                s.onload = function () {
                    vkBridge.subscribe(response => {
                        send(VKBRIDGE_SUBSCRIBE_ID, "subscribe", response);
                    });
                    // Initialize vkBridge
                    vkBridge.send('VKWebAppInit').then(function (response) {
                        if (response.result) {
                            send(VKBRIDGE_INIT_ID, "init", vkBridge);
                        } else {
                            send(VKBRIDGE_INIT_ID, "error", VkBridgeHelper.conver_error("vkBridge is not initialized."));
                        }
                    }).catch(function (err) {
                        send(VKBRIDGE_INIT_ID, "error", VkBridgeHelper.conver_error(err));
                    });

                };
                s.onerror = function () {
                    send(VKBRIDGE_INIT_ID, "error", VkBridgeHelper.conver_error("Error loading VK SDK. Reload the page."));
                };
            }

            VkBridgeHelper.autoInit = true;
            // {{#vk_bridge.auto_init}}
            VkBridgeHelper.autoInit = {{{vk_bridge.auto_init}}};
            // {{/vk_bridge.auto_init}}
            if (VkBridgeHelper.autoInit) {
                VkBridgeHelper.init();
            }
        })(document);
    </script>
</head>

</html>